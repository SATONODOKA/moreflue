<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moreach - Influencer UI (Unified + Chat)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Noto Sans JP', 'Inter', sans-serif; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        /* Brand Colors */
        .bg-main { background-color: #FF6F61; }
        .text-main { color: #FF6F61; }
        .border-main { border-color: #FF6F61; }
        .bg-sub-1 { background-color: #F5F2EF; }
        .text-sub-1 { color: #F5F2EF; }
        .bg-sub-2 { background-color: #3D4F75; }
        .text-sub-2 { color: #3D4F75; }
        .border-sub-2 { border-color: #3D4F75; }
        .bg-accent { background-color: #F4B95F; }
        .text-accent { color: #F4B95F; }
        /* Screen switching */
        .screen { display: none; }
        .screen.active { display: block; }
        /* Bottom nav */
        .bottom-nav-item.active svg { color: #FF6F61; }
        .bottom-nav-item.active p { color: #FF6F61; }
        /* Chat */
        .chat-item:active { filter: brightness(0.97); }
    </style>
</head>
<body class="bg-gray-800 flex justify-center">


    <div class="w-full max-w-sm h-screen bg-sub-1 flex flex-col relative">
        <main class="flex-1 overflow-y-auto pb-20">




            <!-- PROJECTS -->
            <div id="projects" class="screen">
                <header class="p-4 bg-white shadow-sm sticky top-0 z-10">
                    <h1 class="text-xl font-bold text-center text-sub-2">æ¡ˆä»¶ã‚’æ¢ã™</h1>
                </header>
                <div class="p-4 space-y-4">
                    <div class="relative">
                        <input type="text" class="w-full pl-10 pr-4 py-2 border rounded-full" placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ (ä¾‹: æ¸‹è°· ã‚«ãƒ•ã‚§)">
                        <svg class="w-5 h-5 text-gray-400 absolute top-1/2 left-3 -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    </div>
                    <!-- NEW: é£²é£Ÿã‚«ãƒ†ã‚´ãƒªã®æ¡ˆä»¶ã‚«ãƒ¼ãƒ‰ï¼ˆä¾‹ï¼‰ -->
                    <div class="bg-white rounded-lg shadow p-4 space-y-3" data-category="food">
                      <div class="flex justify-between items-start">
                        <h3 class="font-bold text-sub-2 flex-1 mr-2">ã€ä¸­ç›®é»’ã€‘ç‚­ç«ç„¼ãé³¥ã€Œæ¢Ÿã€è©¦é£Ÿãƒ¬ãƒ“ãƒ¥ãƒ¼å‹Ÿé›†</h3>
                        <span class="text-xs font-bold text-main bg-main/10 px-2 py-1 rounded-full whitespace-nowrap">é£²é£Ÿ</span>
                      </div>
                      <p class="text-sm text-gray-600">CLIENT: ç‚­ç«æ¢Ÿ</p>
                      <p class="text-sm text-gray-600">
                        å ±é…¬: ãŠã¾ã‹ã›ã‚³ãƒ¼ã‚¹(Â¥6,000ç›¸å½“)ã®ç„¡å„Ÿæä¾› + æ¥åº—æ•°ã«å¿œã˜ãŸæˆæœå ±é…¬
                      </p>
                      <div class="text-right pt-2">
                        <button class="px-4 py-2 text-sm bg-main text-white rounded-lg font-bold hover:bg-opacity-90">
                          è©³ç´°ãƒ»å¿œå‹Ÿ
                        </button>
                      </div>
                    </div>
                    <div class="bg-white rounded-lg shadow p-4 space-y-3">
                        <div class="flex justify-between items-start">
                            <h3 class="font-bold text-sub-2 flex-1 mr-2">ã€éŒå€‰ã€‘é€±æœ«æ—…ã«ã€‚å¤æ°‘å®¶ã‚²ã‚¹ãƒˆãƒã‚¦ã‚¹ã®å®¿æ³Šä½“é¨“</h3>
                            <span class="text-xs font-bold text-indigo-500 bg-indigo-100 px-2 py-1 rounded-full whitespace-nowrap">æ—…è¡Œ</span>
                        </div>
                        <p class="text-sm text-gray-600">CLIENT: éŒå€‰Breeze</p>
                        <p class="text-sm text-gray-600">å ±é…¬: 1æ³Š2æ—¥å®¿æ³Šç„¡æ–™ + äºˆç´„æ•°ã«å¿œã˜ãŸæˆæœå ±é…¬</p>
                        <div class="text-right pt-2"><button class="px-4 py-2 text-sm bg-main text-white rounded-lg font-bold hover:bg-opacity-90">è©³ç´°ãƒ»å¿œå‹Ÿ</button></div>
                    </div>
                    <div class="bg-white rounded-lg shadow p-4 space-y-3">
                        <div class="flex justify-between items-start">
                            <h3 class="font-bold text-sub-2 flex-1 mr-2">ã€ä»£å®˜å±±ã€‘ç§‹ã®æ–°è‰²ãƒã‚¤ãƒ«ãƒ¢ãƒ‡ãƒ«å‹Ÿé›†</h3>
                            <span class="text-xs font-bold text-pink-500 bg-pink-100 px-2 py-1 rounded-full whitespace-nowrap">ç¾å®¹</span>
                        </div>
                        <p class="text-sm text-gray-600">CLIENT: Nail Salon Chic</p>
                        <p class="text-sm text-gray-600">å ±é…¬: æœ€æ–°ãƒ‡ã‚¶ã‚¤ãƒ³ã®ãƒã‚¤ãƒ«æ–½è¡“(Â¥12,000ç›¸å½“)ç„¡æ–™</p>
                        <div class="text-right pt-2"><button class="px-4 py-2 text-sm bg-main text-white rounded-lg font-bold hover:bg-opacity-90">è©³ç´°ãƒ»å¿œå‹Ÿ</button></div>
                    </div>
                </div>
            </div>


            <!-- ãƒ›ãƒ¼ãƒ ç”»é¢ -->
            <div id="dashboard" class="screen active">
                <header class="p-4 flex justify-between items-center bg-white shadow-sm sticky top-0 z-10">
                    <div class="flex items-center space-x-3">
                        <img class="h-10 w-10 rounded-full object-cover" src="https://placehold.co/100x100/ADD8E6/FFFFFF?text=å¥" alt="ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³">
                        <div>
                            <p class="font-bold text-sm text-sub-2">æ¸¡é‚‰ å¥æ–—ã•ã‚“</p>
                            <p class="text-xs text-gray-500">ã‚¤ãƒ³ãƒ•ãƒ«ã‚¨ãƒ³ã‚µãƒ¼</p>
                        </div>
                    </div>
                    <button class="p-2 rounded-full hover:bg-gray-100" aria-label="é€šçŸ¥">
                        <svg class="h-6 w-6 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/></svg>
                    </button>
                </header>


                <div class="p-4 space-y-6">
                    <div class="bg-white p-4 rounded-lg shadow">
                        <h3 class="font-bold text-sub-2 mb-3">ç¾åœ¨ã®çŠ¶æ³</h3>
                        <div class="grid grid-cols-2 gap-4 text-center">
                            <div>
                                <p class="text-gray-500 text-sm">ä»Šæœˆã®æˆæœå ±é…¬</p>
                                <p class="text-2xl font-bold text-main">Â¥15,800</p>
                            </div>
                            <div>
                                <p class="text-gray-500 text-sm">é€²è¡Œä¸­ã®æ¡ˆä»¶</p>
                                <p class="text-2xl font-bold text-sub-2">3</p>
                            </div>
                        </div>
                    </div>


                    <div>
                        <h3 class="font-bold text-lg text-sub-2 mb-3">æ–°ã—ã„ã‚¹ã‚«ã‚¦ãƒˆ</h3>
                        <div class="bg-white rounded-lg shadow p-4 space-y-3 border-l-4 border-accent">
                            <h4 class="font-bold text-sub-2">ã€æ¸‹è°·ã€‘éš ã‚Œå®¶ã‚¤ã‚¿ãƒªã‚¢ãƒ³ã®PR</h4>
                            <p class="text-sm text-gray-600">FROM: Trattoria Felice</p>
                            <p class="text-sm text-gray-600">å ±é…¬: ãƒ‡ã‚£ãƒŠãƒ¼ã‚³ãƒ¼ã‚¹(Â¥8,000ç›¸å½“)ç„¡å„Ÿæä¾› + æˆæœå ±é…¬</p>
                            <div class="text-right pt-2">
                                <button class="px-4 py-2 text-sm bg-main text-white rounded-lg font-bold hover:bg-opacity-90" data-screen="chat" data-open-chat="c2">è©³ç´°ã‚’è¦‹ã‚‹</button>
                            </div>
                        </div>
                    </div>


                    <div>
                        <h3 class="font-bold text-lg text-sub-2 mb-3">é€²è¡Œä¸­ã®æ¡ˆä»¶</h3>
                        <div class="bg-white rounded-lg shadow p-4 space-y-3">
                            <h4 class="font-bold text-sub-2">è¿‘æ‰€ã®ç¾å‘³ã—ã„éŸ“å›½æ–™ç†åº—ã®é­…åŠ›ç™ºä¿¡</h4>
                            <div class="flex justify-between items-center mt-2">
                                <span class="text-xs text-gray-500">æœŸé™: 2025/08/30</span>
                                <a href="#" class="px-4 py-2 text-sm bg-sub-2 text-white rounded-lg font-bold hover:bg-opacity-90">æŠ•ç¨¿ãƒ»æˆæœç¢ºèª</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


            <!-- æ¡ˆä»¶ç®¡ç†ç”»é¢ -->
            <div id="manage-projects" class="screen">
              <header class="p-4 bg-white shadow-sm sticky top-0 z-10">
                <h1 class="text-xl font-bold text-center text-sub-2">æ¡ˆä»¶ç®¡ç†</h1>


                <!-- NEW: ç¨®é¡ã‚¿ãƒ– -->
                <div id="mpKindTabs" class="mt-3 grid grid-cols-3 gap-2" role="tablist">
                  <button class="mp-kind-tab px-3 py-2 text-[11px] rounded-full border border-gray-200 bg-white font-bold" data-kind="all">
                    ã™ã¹ã¦ <span class="mp-kind-count ml-1 text-[10px] text-gray-400">0</span>
                  </button>
                  <button class="mp-kind-tab px-3 py-2 text-[11px] rounded-full border border-gray-200 bg-white" data-kind="apply">
                    å¿œå‹Ÿä¸­ <span class="mp-kind-count ml-1 text-[10px] text-gray-400">0</span>
                  </button>
                  <button class="mp-kind-tab px-3 py-2 text-[11px] rounded-full border border-gray-200 bg-white" data-kind="scout">
                    ã‚¹ã‚«ã‚¦ãƒˆ <span class="mp-kind-count ml-1 text-[10px] text-gray-400">0</span>
                  </button>
                </div>


                <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚¿ãƒ–ï¼ˆ3ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«çµ±ä¸€ï¼‰ -->
                <div id="mpTabs" class="mt-3 grid grid-cols-3 gap-2" role="tablist">
                  <button class="mp-tab px-3 py-2 text-[11px] rounded-full border border-gray-200 bg-white font-bold" data-tab="not_started">
                    æœªé–‹å§‹ <span class="mp-count ml-1 text-[10px] text-gray-400">0</span>
                  </button>
                  <button class="mp-tab px-3 py-2 text-[11px] rounded-full border border-gray-200 bg-white" data-tab="in_progress">
                    é€²è¡Œä¸­ <span class="mp-count ml-1 text-[10px] text-gray-400">0</span>
                  </button>
                  <button class="mp-tab px-3 py-2 text-[11px] rounded-full border border-gray-200 bg-white" data-tab="done">
                    å®Œäº† <span class="mp-count ml-1 text-[10px] text-gray-400">0</span>
                  </button>
                </div>
              </header>


              <!-- KPIã‚µãƒãƒªãƒ¼ -->
              <section class="p-4 grid grid-cols-3 gap-3">
                <div class="bg-white rounded-lg shadow p-3 text-center">
                  <p class="text-[11px] text-gray-500">é€²è¡Œä¸­</p>
                  <p id="mpKpiInProgress" class="text-xl font-bold text-sub-2">0</p>
                </div>
                <div class="bg-white rounded-lg shadow p-3 text-center">
                  <p class="text-[11px] text-gray-500">ä»Šæœˆ è¦‹è¾¼å ±é…¬</p>
                  <p id="mpKpiExpected" class="text-xl font-bold text-main">Â¥0</p>
                </div>
                <div class="bg-white rounded-lg shadow p-3 text-center">
                  <p class="text-[11px] text-gray-500">ä»Šé€± æœŸé™</p>
                  <p id="mpKpiDueThisWeek" class="text-xl font-bold text-sub-2">0</p>
                </div>
              </section>


              <!-- ä¸€è¦§ -->
              <div id="mpList" class="p-4 space-y-3"></div>
            </div>


            <!-- PROFILE -->
            <div id="profile" class="screen">
                <header class="p-4 bg-white shadow-sm sticky top-0 z-10">
                    <h1 class="text-xl font-bold text-center text-sub-2">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</h1>
                </header>
                <div class="p-4 space-y-6">
                    <div class="bg-white rounded-lg shadow p-4 space-y-3">
                        <h3 class="font-bold text-sub-2">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ±</h3>
                        <p class="text-sm">æ°å: æ¸¡é‚‰ å¥æ–—</p>
                        <p class="text-sm">å¾—æ„ãªã‚«ãƒ†ã‚´ãƒª: é£²é£Ÿåº—, æ—…è¡Œ</p>
                        <p class="text-sm">é€£æºSNS: @kento_foodie</p>
                        <div class="text-right pt-2">
                            <button class="px-4 py-2 text-sm bg-sub-2 text-white rounded-lg font-bold hover:bg-opacity-90">ç·¨é›†</button>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg shadow p-4 space-y-3">
                        <h3 class="font-bold text-sub-2">å ±é…¬å—å–å£åº§</h3>
                        <p class="text-sm">â—â—éŠ€è¡Œ â—â—æ”¯åº—</p>
                        <p class="text-sm">æ™®é€š 1234567</p>
                        <div class="text-right pt-2">
                            <button class="px-4 py-2 text-sm border border-sub-2 text-sub-2 rounded-lg font-bold hover:bg-gray-50">å¤‰æ›´</button>
                        </div>
                    </div>
                </div>
            </div>


            <!-- CHAT -->
            <div id="chat" class="screen">
                <header class="p-4 bg-white shadow-sm sticky top-0 z-20">
                    <div class="flex items-center justify-between">
                        <h1 class="text-xl font-bold text-sub-2">ãƒãƒ£ãƒƒãƒˆ</h1>
                        <button id="chatBackBtn" class="hidden p-2 text-sub-2 rounded-lg hover:bg-gray-100">ä¸€è¦§ã¸</button>
                    </div>
                    <!-- Tabs -->
                    <div id="chatTabs" class="mt-3 grid grid-cols-3 gap-2" role="tablist">
                        <button class="chat-tab px-3 py-2 text-xs rounded-full border border-gray-200 bg-white font-bold" data-tab="all">ã™ã¹ã¦</button>
                        <button class="chat-tab px-3 py-2 text-xs rounded-full border border-gray-200 bg-white" data-tab="active">é€²è¡Œä¸­</button>
                        <button class="chat-tab px-3 py-2 text-xs rounded-full border border-gray-200 bg-white" data-tab="archived">ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–</button>
                    </div>
                </header>


                <!-- List -->
                <div id="chatList" class="p-4 space-y-2"></div>


                <!-- Detail -->
                <div id="chatDetail" class="hidden flex flex-col h-full">
                    <div class="p-4 bg-white border-b border-gray-100 sticky top-[64px] z-10">
                        <div class="flex items-center space-x-3">
                            <img id="chatDetailAvatar" class="h-8 w-8 rounded-full object-cover" src="" alt="avatar">
                            <div>
                                <p id="chatDetailName" class="font-bold text-sub-2"></p>
                                <p id="chatDetailMeta" class="text-xs text-gray-500"></p>
                            </div>
                        </div>
                    </div>


                    <div id="chatMessages" class="flex-1 p-4 space-y-3 overflow-y-auto"></div>


                    <div class="p-3 bg-white border-t border-gray-200 sticky bottom-0">
                        <form id="chatForm" class="flex items-center space-x-2">
                            <input id="chatInput" type="text" class="flex-1 px-3 py-2 border rounded-full text-sm" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›">
                            <button class="px-3 py-2 rounded-full bg-main text-white text-sm font-bold">é€ä¿¡</button>
                        </form>
                    </div>
                </div>
            </div>
        </main>


        <!-- BOTTOM NAV -->
        <nav class="fixed bottom-0 left-0 right-0 w-full max-w-sm mx-auto bg-white border-t border-gray-200 flex justify-around shadow-top z-20" role="navigation">
            <!-- ãƒ›ãƒ¼ãƒ  -->
            <a href="#" class="bottom-nav-item flex-1 flex flex-col items-center justify-center pt-2 pb-1 text-center" data-screen="dashboard">
                <svg class="h-6 w-6 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                </svg>
                <p class="text-xs text-gray-500">ãƒ›ãƒ¼ãƒ </p>
            </a>


            <!-- NEW: æ¡ˆä»¶ç®¡ç† -->
            <a href="#" class="bottom-nav-item flex-1 flex flex-col items-center justify-center pt-2 pb-1 text-center" data-screen="manage-projects">
                <svg class="h-6 w-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M3 7h18M3 12h18M3 17h18" />
                </svg>
                <p class="text-xs text-gray-500">æ¡ˆä»¶ç®¡ç†</p>
            </a>


            <!-- æ¡ˆä»¶ã‚’æ¢ã™ -->
            <a href="#" class="bottom-nav-item flex-1 flex flex-col items-center justify-center pt-2 pb-1 text-center" data-screen="projects">
                <svg class="h-6 w-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
                <p class="text-xs text-gray-500">æ¡ˆä»¶ã‚’æ¢ã™</p>
            </a>


            <!-- ãƒãƒ£ãƒƒãƒˆ -->
            <a href="#" class="bottom-nav-item flex-1 flex flex-col items-center justify-center pt-2 pb-1 text-center" data-screen="chat">
                <svg class="h-6 w-6 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M7 8h10M7 12h6m-9 8l1.5-3A8.97 8.97 0 013 9a9 9 0 1117.32 4.906L21 20l-3.906-1.68A9 9 0 013 9" />
                </svg>
                <p class="text-xs text-gray-500">ãƒãƒ£ãƒƒãƒˆ</p>
            </a>


            <!-- ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ« -->
            <a href="#" class="bottom-nav-item flex-1 flex flex-col items-center justify-center pt-2 pb-1 text-center" data-screen="profile">
                <svg class="h-6 w-6 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                </svg>
                <p class="text-xs text-gray-500">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</p>
            </a>
        </nav>
    </div>


    <!-- NEW: ç´å“ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="deliverModal" class="fixed inset-0 z-40 hidden">
      <div class="absolute inset-0 bg-black/40"></div>
      <div class="absolute inset-x-0 bottom-0 bg-white rounded-t-2xl p-4 space-y-3 max-w-sm mx-auto">
        <div class="flex items-center justify-between">
          <h3 class="font-bold text-sub-2">ç´å“</h3>
          <button id="deliverClose" class="p-2 text-gray-500 hover:bg-gray-100 rounded-lg">é–‰ã˜ã‚‹</button>
        </div>
        <form id="deliverForm" class="space-y-3">
          <input type="hidden" id="deliverProjectId">
          <div>
            <label class="block text-xs text-gray-500 mb-1">æŠ•ç¨¿URLï¼ˆå¿…é ˆï¼‰</label>
            <input id="deliverUrl" type="url" required placeholder="https://..."
                   class="w-full border rounded-md px-3 py-2 text-sm" />
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-xs text-gray-500 mb-1">ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ </label>
              <select id="deliverPlatform" class="w-full border rounded-md px-2 py-2 text-sm">
                <option value="">é¸æŠãªã—</option>
                <option>Instagram</option>
                <option>TikTok</option>
                <option>X</option>
                <option>YouTube</option>
                <option>Blog</option>
              </select>
            </div>
            <div>
              <label class="block text-xs text-gray-500 mb-1">æŠ•ç¨¿æ—¥æ™‚</label>
              <input id="deliverPostedAt" type="datetime-local" class="w-full border rounded-md px-2 py-2 text-sm" />
            </div>
          </div>
          <div>
            <label class="block text-xs text-gray-500 mb-1">ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label>
            <textarea id="deliverNote" rows="2" class="w-full border rounded-md px-3 py-2 text-sm"
                      placeholder="ä¾‹ï¼‰ãƒªãƒ¼ãƒ«20ç§’/åº—èˆ—ã‚¿ã‚°ä»˜ã‘æ¸ˆã¿ ãªã©"></textarea>
          </div>
          <button class="w-full bg-main text-white font-bold rounded-lg py-2">ã“ã®å†…å®¹ã§ç´å“</button>
        </form>
      </div>
    </div>


<script>
// ------------------- State -------------------
const state = {
  currentTab: 'all',
  selectedChatId: null,
  chats: [
    {
      id: 'c1',
      name: 'ã‚½ã‚¦ãƒ«ã‚­ãƒƒãƒãƒ³',
      avatar: 'https://placehold.co/64x64/FF6F61/FFFFFF?text=SK',
      status: 'active', // active|archived
      lastMessage: '9/1ã®æŠ•ç¨¿ã€å•é¡Œã‚ã‚Šã¾ã›ã‚“ï¼',
      lastAt: '2025/08/11 18:32',
      unread: 1,
      messages: [
        { from: 'client', text: '9/1ã®æŠ•ç¨¿ã€å•é¡Œã‚ã‚Šã¾ã›ã‚“ï¼', at: '2025/08/11 18:32' },
        { from: 'me', text: 'å†…å®¹ã”ç¢ºèªã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚', at: '2025/08/11 18:25' }
      ]
    },
    {
      id: 'c2',
      name: 'Trattoria Felice',
      avatar: 'https://placehold.co/64x64/3D4F75/FFFFFF?text=TF',
      status: 'active',
      lastMessage: 'ã”å¿œå‹Ÿã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼è©³ç´°å…±æœ‰ã—ã¾ã™ã€‚',
      lastAt: '2025/08/10 12:03',
      unread: 2,
      messages: [
        { from: 'client', text: 'ã”å¿œå‹Ÿã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼è©³ç´°å…±æœ‰ã—ã¾ã™ã€‚', at: '2025/08/10 12:03' },
        { from: 'me', text: 'ã“ã¡ã‚‰ã®PRã«èˆˆå‘³ãŒã‚ã‚Šã¾ã™ã€‚', at: '2025/08/10 11:54' }
      ]
    },
    {
      id: 'c3',
      name: 'Nail Salon Chic',
      avatar: 'https://placehold.co/64x64/F4B95F/3D4F75?text=NS',
      status: 'archived',
      lastMessage: 'ä»Šå›ã¯ã“ã“ã¾ã§ã§ã‚¯ãƒ­ãƒ¼ã‚ºã«ã—ã¾ã—ã‚‡ã†ã€‚',
      lastAt: '2025/07/29 09:20',
      unread: 0,
      messages: [
        { from: 'client', text: 'ä»Šå›ã¯ã“ã“ã¾ã§ã§ã‚¯ãƒ­ãƒ¼ã‚ºã«ã—ã¾ã—ã‚‡ã†ã€‚', at: '2025/07/29 09:20' },
        { from: 'me', text: 'æ‰¿çŸ¥ã—ã¾ã—ãŸã€‚ã¾ãŸæ©Ÿä¼šãŒã‚ã‚Œã°ï¼', at: '2025/07/29 09:18' }
      ]
    }
  ],
  // --- æ¡ˆä»¶ç®¡ç†ãƒ‡ãƒ¼ã‚¿ï¼ˆ3ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹çµ±ä¸€ï¼‰ ---
  manage: {
    currentKind: 'all',        // ç¨®é¡ãƒ•ã‚£ãƒ«ã‚¿  all | apply | scout
    currentTab: 'not_started', // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹   not_started | in_progress | done
    projects: [
      {
        id: 'p1',
        kind: 'scout', // ã‚¹ã‚«ã‚¦ãƒˆç”±æ¥
        title: 'ã‚½ã‚¦ãƒ«ã‚­ãƒƒãƒãƒ³æ§˜ï¼šæ¥åº—ä¿ƒé€²æŠ•ç¨¿ï¼ˆ8æœˆï¼‰',
        client: 'ã‚½ã‚¦ãƒ«ã‚­ãƒƒãƒãƒ³',
        deadline: '2025/08/30',
        status: 'in_progress',
        payout: { base: 'è©¦é£Ÿã‚³ãƒ¼ã‚¹(Â¥6,000ç›¸å½“)ç„¡å„Ÿæä¾›', model: 'æ¥åº—æ•°Ã—Â¥200' },
        metrics: { visits: 32, clicks: 450, reward: 6400 },
        chatId: 'c1',
        deliveries: [], // {url, platform, postedAt, note, at}
        approval: 'none' // none | pending | approved | rejected
      },
      {
        id: 'p2',
        kind: 'apply', // å¿œå‹Ÿç”±æ¥
        title: 'Trattoria Feliceæ§˜',
        client: 'Trattoria Felice',
        deadline: '2025/08/22',
        status: 'not_started', // awaiting â†’ not_started ã«ç§»è¡Œ
        payout: { base: 'ãƒ‡ã‚£ãƒŠãƒ¼ã‚³ãƒ¼ã‚¹(Â¥8,000)ç„¡å„Ÿæä¾›', model: 'äºˆç´„1ä»¶Ã—Â¥500' },
        metrics: { visits: 0, clicks: 0, reward: 0 },
        chatId: 'c2',
        deliveries: [],
        approval: 'none'
      },
      {
        id: 'p3',
        kind: 'apply',
        title: 'Nail Salon Chicæ§˜',
        client: 'Nail Salon Chic',
        deadline: '2025/09/05',
        status: 'not_started', // draft â†’ not_started ã«ç§»è¡Œ
        payout: { base: 'æ–½è¡“(Â¥12,000)ç„¡å„Ÿæä¾›', model: 'äºˆç´„1ä»¶Ã—Â¥400' },
        metrics: { visits: 0, clicks: 0, reward: 0 },
        chatId: 'c3',
        deliveries: [],
        approval: 'none'
      },
      {
        id: 'p4',
        kind: 'scout',
        title: 'éŒå€‰Breezeæ§˜',
        client: 'éŒå€‰Breeze',
        deadline: '2025/08/12',
        status: 'done',
        payout: { base: '1æ³Š2æ—¥ç„¡å„Ÿ', model: 'äºˆç´„1ä»¶Ã—Â¥600' },
        metrics: { visits: 21, clicks: 310, reward: 7200 },
        chatId: 'c4',
        deliveries: [],
        approval: 'none'
      }
    ]
  }
};


// ------------------- Utilities -------------------
function $(sel, root=document) { return root.querySelector(sel); }
function $all(sel, root=document) { return Array.from(root.querySelectorAll(sel)); }


function formatBadge(unread) {
  if (!unread) return '';
  return `<span class="ml-auto inline-flex items-center justify-center min-w-[20px] h-5 px-1 text-[10px] font-bold text-white bg-main rounded-full">${unread}</span>`;
}


// --- æ¡ˆä»¶ç®¡ç†ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ---
function jpy(n){ return 'Â¥' + (n||0).toLocaleString('ja-JP'); }
function withinThisWeek(dateStr){
  const d = new Date(dateStr.replaceAll('/', '-'));
  const now = new Date();
  const diff = (d - now) / (1000*60*60*24);
  return diff >= 0 && diff < 7;
}
function labelOf(status){
  return ({ not_started: 'æœªé–‹å§‹', in_progress: 'é€²è¡Œä¸­', done: 'å®Œäº†' })[status] || status;
}
function badgeCls(status){
  return ({
    not_started: 'text-gray-700 bg-gray-100',
    in_progress: 'text-indigo-700 bg-indigo-100',
    done: 'text-emerald-700 bg-emerald-100'
  })[status] || 'text-gray-600 bg-gray-100';
}


// --- ç¨®é¡ã‚¿ãƒ–ç”¨ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ---
function kindLabel(kind){
  return kind === 'apply' ? 'å¿œå‹Ÿ' : kind === 'scout' ? 'ã‚¹ã‚«ã‚¦ãƒˆ' : '';
}
function kindBadgeCls(kind){
  return kind === 'apply' ? 'text-sky-700 bg-sky-100' :
         kind === 'scout' ? 'text-fuchsia-700 bg-fuchsia-100' : 'text-gray-600 bg-gray-100';
}


// ------------------- Chat List Rendering -------------------
function renderChatList() {
  const container = $('#chatList');
  const { currentTab, chats } = state;
  const filtered = chats.filter(c => currentTab === 'all' ? true : c.status === currentTab);


  if (filtered.length === 0) {
    container.innerHTML = `<div class="text-center text-gray-500 text-sm py-10">ã“ã®ã‚¿ãƒ–ã®ãƒãƒ£ãƒƒãƒˆã¯ã‚ã‚Šã¾ã›ã‚“</div>`;
    return;
  }


  container.innerHTML = filtered.map(c => `
    <button class="chat-item w-full bg-white rounded-lg shadow p-3 flex items-center space-x-3" data-chat-id="${c.id}">
      <img src="${c.avatar}" alt="${c.name}" class="h-10 w-10 rounded-full object-cover" />
      <div class="flex-1 text-left">
        <div class="flex items-center space-x-2">
          <p class="font-bold text-sub-2 truncate max-w-[150px]">${c.name}</p>
          <p class="text-[10px] text-gray-400">${c.lastAt}</p>
          ${formatBadge(c.unread)}
        </div>
        <p class="text-xs text-gray-500 truncate">${c.lastMessage}</p>
      </div>
    </button>
  `).join('');
}


// ------------------- æ¡ˆä»¶ç®¡ç†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ï¼ˆ3ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹çµ±ä¸€ï¼‰ -------------------
function renderManage(){
  const { currentKind, currentTab, projects } = state.manage;


  // --- ç¨®é¡ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆå¿œå‹Ÿ/ã‚¹ã‚«ã‚¦ãƒˆï¼‰ ---
  const byKind = projects.filter(p => currentKind === 'all' ? true : p.kind === currentKind);


  // --- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆæœªé–‹å§‹/é€²è¡Œä¸­/å®Œäº†ï¼‰ ---
  const list = byKind.filter(p => currentTab === 'not_started'
    ? p.status === 'not_started'
    : currentTab === 'in_progress'
      ? p.status === 'in_progress'
      : p.status === 'done'
  );


  // ç¨®åˆ¥ä»¶æ•°ï¼ˆä¸Šæ®µï¼‰
  const kindCounts = {
    all: projects.length,
    apply: projects.filter(p=>p.kind==='apply').length,
    scout: projects.filter(p=>p.kind==='scout').length
  };
  $all('#mpKindTabs .mp-kind-tab').forEach(btn=>{
    const key = btn.dataset.kind;
    const el = btn.querySelector('.mp-kind-count');
    if (el) el.textContent = kindCounts[key] ?? 0;
    const active = key === currentKind;
    btn.classList.toggle('font-bold', active);
    btn.classList.toggle('border-main', active);
    btn.classList.toggle('text-main', active);
  });


  // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ä»¶æ•°ï¼ˆç¾åœ¨ã®ç¨®é¡ãƒ•ã‚£ãƒ«ã‚¿ã‚’é©ç”¨ã—ãŸæ¯é›†å›£ã§è¨ˆç®—ï¼‰
  const counts = {
    not_started: byKind.filter(p=>p.status==='not_started').length,
    in_progress: byKind.filter(p=>p.status==='in_progress').length,
    done: byKind.filter(p=>p.status==='done').length
  };
  $all('#mpTabs .mp-tab').forEach(tab=>{
    const key = tab.dataset.tab;
    const el = tab.querySelector('.mp-count');
    if (el) el.textContent = counts[key] ?? 0;
    const active = key === currentTab;
    tab.classList.toggle('font-bold', active);
    tab.classList.toggle('border-main', active);
    tab.classList.toggle('text-main', active);
  });


  // KPIï¼ˆé€²è¡Œä¸­ã®è¦‹è¾¼å ±é…¬åˆè¨ˆï¼‰
  $('#mpKpiInProgress').textContent = counts.in_progress || 0;
  const expected = byKind
    .filter(p=>p.status==='in_progress')
    .reduce((sum,p)=> sum + (p.metrics?.reward||0), 0);
  $('#mpKpiExpected').textContent = jpy(expected);
  const due = byKind.filter(p=>withinThisWeek(p.deadline) && (p.status!=='done')).length;
  $('#mpKpiDueThisWeek').textContent = due;


  // ä¸€è¦§æç”»
  const container = $('#mpList');
  if (list.length === 0){
    container.innerHTML = `<div class="text-center text-gray-500 text-sm py-10">ã“ã®æ¡ä»¶ã®æ¡ˆä»¶ã¯ã‚ã‚Šã¾ã›ã‚“</div>`;
    return;
  }
  container.innerHTML = list.map(p => `
    <div class="bg-white rounded-lg shadow p-4 space-y-2">
      <div class="flex items-start justify-between">
        <div class="pr-3">
          <h3 class="font-bold text-sub-2 leading-snug">${p.title}</h3>
          <p class="text-xs text-gray-500 mt-1">CLIENT: ${p.client}</p>
        </div>
        <div class="flex gap-2 shrink-0">
          <span class="text-[10px] px-2 py-1 rounded-full ${p.kind==='apply' ? 'text-sky-700 bg-sky-100' : 'text-fuchsia-700 bg-fuchsia-100'}">
            ${p.kind==='apply'?'å¿œå‹Ÿ':'ã‚¹ã‚«ã‚¦ãƒˆ'}
          </span>
          <span class="text-[10px] px-2 py-1 rounded-full ${badgeCls(p.status)}">${labelOf(p.status)}</span>
        </div>
      </div>


      <div class="grid grid-cols-3 gap-2 text-center mt-1">
        <div>
          <p class="text-[11px] text-gray-500">æœŸé™</p>
          <p class="text-sm font-bold text-sub-2">${p.deadline}</p>
        </div>
        <div>
          <p class="text-[11px] text-gray-500">å ±é…¬</p>
          <p class="text-sm font-bold text-main">${jpy(p.metrics?.reward)}</p>
        </div>
        <div>
          <p class="text-[11px] text-gray-500">æ¥åº—/ã‚¯ãƒªãƒƒã‚¯(äºº)</p>
          <p class="text-sm font-bold text-sub-2">${p.metrics?.visits||0} / ${p.metrics?.clicks||0}</p>
        </div>
      </div>


      <div class="space-y-1">
        <div class="text-[11px] text-gray-500">
          ç„¡å„Ÿæä¾›: <span class="text-gray-800">${p.payout.base}</span>
        </div>
        <div class="text-[11px] text-gray-500">
          æˆæœ: <span class="text-gray-800">${p.payout.model}</span>
        </div>
      </div>


      <div class="flex items-center gap-2">
        <label class="text-xs text-gray-500">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
        <select class="mp-status border rounded-md text-xs px-2 py-1" data-id="${p.id}">
          <option value="not_started" ${p.status==='not_started'?'selected':''}>æœªé–‹å§‹</option>
          <option value="in_progress" ${p.status==='in_progress'?'selected':''}>é€²è¡Œä¸­</option>
          <option value="done" ${p.status==='done'?'selected':''}>å®Œäº†</option>
        </select>


        <div class="ml-auto flex items-center gap-2">
          <button class="mp-open-chat px-3 py-1.5 rounded-full border border-sub-2 text-sub-2 text-xs font-bold hover:bg-gray-50"
                  data-open-chat="${p.chatId||''}">ãƒãƒ£ãƒƒãƒˆ</button>
          <button class="mp-deliver px-3 py-1.5 rounded-full bg-accent text-white text-xs font-bold hover:bg-opacity-90"
                  data-id="${p.id}">ç´å“</button>
        </div>
      </div>
    </div>
  `).join('');
}


// ã‚¿ãƒ–åˆ‡æ›¿
function activateManageTab(tab){
  state.manage.currentTab = tab;
  renderManage();
}


// ç¨®é¡ã‚¿ãƒ–åˆ‡æ›¿
function activateManageKind(kind){
  state.manage.currentKind = kind;
  renderManage();
}


// ------------------- ç´å“ãƒ¢ãƒ¼ãƒ€ãƒ«æ©Ÿèƒ½ -------------------
function openDeliverModal(projectId){
  $('#deliverProjectId').value = projectId;
  $('#deliverUrl').value = '';
  $('#deliverPlatform').value = '';
  $('#deliverPostedAt').value = '';
  $('#deliverNote').value = '';
  $('#deliverModal').classList.remove('hidden');
}


function closeDeliverModal(){
  $('#deliverModal').classList.add('hidden');
}


function appendDeliveryToChat(project, payload){
  // ç´å“ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆãƒãƒ£ãƒƒãƒˆã¸è‡ªå‹•æŠ•ç¨¿ï¼‰
  const chat = state.chats?.find(c => c.id === project.chatId);
  if (!chat) return;


  const now = new Date().toLocaleString('ja-JP', { hour12: false });
  const lines = [
    'ğŸ”” ç´å“ãŒæå‡ºã•ã‚Œã¾ã—ãŸã€‚',
    `URL: ${payload.url}`,
    payload.platform ? `ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ : ${payload.platform}` : '',
    payload.postedAt ? `æŠ•ç¨¿æ—¥æ™‚: ${payload.postedAt}` : '',
    payload.note ? `ãƒ¡ãƒ¢: ${payload.note}` : '',
    '',
    // æ‰¿èª/å·®ã—æˆ»ã—ï¼ˆãƒ‡ãƒ¢ç”¨ã®æ“¬ä¼¼ãƒœã‚¿ãƒ³ï¼‰
    'ã€Šæ‰¿èª or å·®ã—æˆ»ã—ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‹'
  ].filter(Boolean).join('\n');


  // ç´å“ã¯ã‚·ã‚¹ãƒ†ãƒ é€šçŸ¥æ‰±ã„ã§ "me" ã‹ã‚‰é€ã‚‹ï¼ˆé‹ç”¨ã«åˆã‚ã›ã¦å¤‰æ›´å¯ï¼‰
  chat.messages.push({ from: 'me', text: lines, at: now, kind: 'delivery_notice' });


  // ä¼æ¥­å´ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ç”¨ã«æ“¬ä¼¼ãƒœã‚¿ãƒ³ã‚’è¡¨ç¾ï¼ˆã‚¯ãƒªãƒƒã‚¯ã‚’å§”è­²ã§æ‹¾ã†ï¼‰
  chat.messages.push({
    from: 'client',
    text: `[æ‰¿èªã™ã‚‹]  [å·®ã—æˆ»ã™]`,
    at: now,
    kind: 'approval_actions',
    meta: { projectId: project.id }
  });


  chat.lastMessage = 'ç´å“ã‚’æå‡ºã—ã¾ã—ãŸã€‚æ‰¿èªå¾…ã¡ã§ã™ã€‚';
  chat.lastAt = now;
}


function handleDeliverSubmit(e){
  e.preventDefault();
  const projectId = $('#deliverProjectId').value;
  const url = $('#deliverUrl').value.trim();
  if (!url) return;


  const payload = {
    url,
    platform: $('#deliverPlatform').value,
    postedAt: $('#deliverPostedAt').value,
    note: $('#deliverNote').value,
    at: new Date().toISOString()
  };
  const proj = state.manage.projects.find(p => p.id === projectId);
  if (!proj) return;


  // ä¿å­˜
  proj.deliveries.push(payload);
  proj.approval = 'pending';


  // ãƒãƒ£ãƒƒãƒˆã¸è‡ªå‹•é€šçŸ¥
  appendDeliveryToChat(proj, payload);


  // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã¯ä»»æ„ï¼šæœªé–‹å§‹â†’é€²è¡Œä¸­ ã«ã¯è‡ªå‹•ã§ã—ã¦ãŠãã¨æ··ä¹±ãŒå°‘ãªã„
  if (proj.status === 'not_started') proj.status = 'in_progress';


  renderManage();
  closeDeliverModal();


  // ç´å“å¾Œã™ããƒãƒ£ãƒƒãƒˆã¸é·ç§»ã—ã¦ç¢ºèªã—ãŸã„å ´åˆã¯ä»¥ä¸‹ã‚’æœ‰åŠ¹ã«
  showScreen('chat');
  if (typeof openChatDetail === 'function') setTimeout(()=> openChatDetail(proj.chatId), 0);
}


// ------------------- Chat Detail Rendering -------------------
function openChatDetail(chatId) {
  state.selectedChatId = chatId;
  const chat = state.chats.find(c => c.id === chatId);
  if (!chat) return;


  // Header
  $('#chatDetailAvatar').src = chat.avatar;
  $('#chatDetailAvatar').alt = chat.name;
  $('#chatDetailName').textContent = chat.name;
  $('#chatDetailMeta').textContent = chat.lastAt + ' æ›´æ–°';


  // Messages
  const box = $('#chatMessages');
  box.innerHTML = chat.messages.map(m => {
    const isMe = m.from === 'me';
    return `
      <div class="flex ${isMe ? 'justify-end' : 'justify-start'}">
        <div class="max-w-[75%] px-3 py-2 rounded-2xl text-sm shadow ${isMe ? 'bg-main text-white rounded-br-sm' : 'bg-white text-gray-800 rounded-bl-sm'}">
          <p>${m.text}</p>
          <p class="text-[10px] mt-1 ${isMe ? 'text-white/80' : 'text-gray-400'}">${m.at}</p>
        </div>
      </div>`;
  }).join('');


  // Reset unread
  chat.unread = 0;
  renderChatList();


  // Toggle views
  $('#chatList').classList.add('hidden');
  $('#chatDetail').classList.remove('hidden');
  $('#chatBackBtn').classList.remove('hidden');


  // Scroll to bottom
  const msgPane = $('#chatMessages');
  msgPane.scrollTop = msgPane.scrollHeight;
}


function backToChatList() {
  state.selectedChatId = null;
  $('#chatDetail').classList.add('hidden');
  $('#chatList').classList.remove('hidden');
  $('#chatBackBtn').classList.add('hidden');
}


// ------------------- Tabs -------------------
function activateTab(tab) {
  state.currentTab = tab;
  $all('.chat-tab').forEach(btn => {
    const active = btn.dataset.tab === tab;
    btn.classList.toggle('font-bold', active);
    btn.classList.toggle('border-main', active);
    btn.classList.toggle('text-main', active);
  });
  renderChatList();
}


// ------------------- App Shell -------------------
document.addEventListener('DOMContentLoaded', function() {
  const screens = document.querySelectorAll('.screen');
  const navItems = document.querySelectorAll('.bottom-nav-item');


  // Screen switcher
  function showScreen(screenId) {
    screens.forEach(screen => screen.classList.remove('active'));
    const activeScreen = document.getElementById(screenId);
    if (activeScreen) activeScreen.classList.add('active');


    navItems.forEach(item => item.classList.remove('active'));
    const activeNavItem = document.querySelector(`.bottom-nav-item[data-screen="${screenId}"]`);
    if (activeNavItem) activeNavItem.classList.add('active');


    const mainScroller = document.querySelector('main');
    if (mainScroller) mainScroller.scrollTop = 0;


    // When entering chat, ensure list view and tabs are fresh
    if (screenId === 'chat') {
      backToChatList();
      activateTab(state.currentTab);
    }
  }


  // Expose for deep-link buttons (e.g., dashboard "è©³ç´°ã‚’è¦‹ã‚‹")
  window.showScreen = showScreen;


  // Bottom nav events
  navItems.forEach(item => {
    item.addEventListener('click', function(e) {
      e.preventDefault();
      const screenId = this.dataset.screen;
      showScreen(screenId);
    });
  });


  // Deep link open chat button in dashboard
  document.body.addEventListener('click', (e) => {
    const btn = e.target.closest('[data-open-chat]');
    if (btn) {
      const chatId = btn.getAttribute('data-open-chat');
      showScreen('chat');
      // wait a tick to ensure chat view is ready
      setTimeout(() => openChatDetail(chatId), 0);
    }
  });


  // Chat tabs
  $all('.chat-tab').forEach(btn => btn.addEventListener('click', () => activateTab(btn.dataset.tab)));


  // Chat list click (event delegation)
  $('#chat').addEventListener('click', (e) => {
    const item = e.target.closest('.chat-item');
    if (item) {
      openChatDetail(item.dataset.chatId);
    }
  });


  // Back from detail
  $('#chatBackBtn').addEventListener('click', backToChatList);


  // Send message (demo only)
  $('#chatForm').addEventListener('submit', (e) => {
    e.preventDefault();
    const input = $('#chatInput');
    const txt = input.value.trim();
    if (!txt || !state.selectedChatId) return;
    const chat = state.chats.find(c => c.id === state.selectedChatId);
    chat.messages.push({ from: 'me', text: txt, at: new Date().toLocaleString('ja-JP', { hour12: false }) });
    chat.lastMessage = txt;
    chat.lastAt = new Date().toLocaleString('ja-JP', { hour12: false });
    input.value = '';
    openChatDetail(chat.id);
  });


  // --- æ¡ˆä»¶ç®¡ç†ï¼šåˆæœŸåŒ– ---
  function initManage(){
    // NEW: ç¨®é¡ã‚¿ãƒ–ã‚¤ãƒ™ãƒ³ãƒˆ
    $all('#mpKindTabs .mp-kind-tab').forEach(btn=>{
      btn.addEventListener('click', ()=> activateManageKind(btn.dataset.kind));
    });


    // æ—¢å­˜: ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚¿ãƒ–ã‚¤ãƒ™ãƒ³ãƒˆ
    $all('#mpTabs .mp-tab').forEach(btn=>{
      btn.addEventListener('click', ()=> activateManageTab(btn.dataset.tab));
    });


    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´ï¼ˆå§”è­²ï¼‰
    const list = $('#mpList');
    list.addEventListener('change', (e)=>{
      const sel = e.target.closest('.mp-status');
      if (!sel) return;
      const id = sel.dataset.id;
      const proj = state.manage.projects.find(p=>p.id===id);
      if (proj){
        proj.status = sel.value;
        renderManage();
      }
    });


    // ãƒãƒ£ãƒƒãƒˆã¸ï¼ˆå§”è­²ï¼‰
    list.addEventListener('click', (e)=>{
      const btn = e.target.closest('.mp-open-chat');
      if (!btn) return;
      const chatId = btn.getAttribute('data-open-chat');
      if (chatId){
        showScreen('chat');
        // æ—¢å­˜ã®ãƒãƒ£ãƒƒãƒˆè©³ç´°ã‚ªãƒ¼ãƒ—ãƒ³é–¢æ•°ãŒã‚ã‚‹å ´åˆï¼š
        if (typeof openChatDetail === 'function') {
          setTimeout(()=> openChatDetail(chatId), 0);
        }
      }
    });


    // ç´å“ãƒ¢ãƒ¼ãƒ€ãƒ«é–‹é–‰
    $('#deliverClose').addEventListener('click', closeDeliverModal);
    $('#deliverForm').addEventListener('submit', handleDeliverSubmit);


    // æ¡ˆä»¶ã‚«ãƒ¼ãƒ‰ï¼šç´å“ãƒœã‚¿ãƒ³ï¼ˆå§”è­²ï¼‰
    list.addEventListener('click', (e)=>{
      const btn = e.target.closest('.mp-deliver');
      if (!btn) return;
      openDeliverModal(btn.getAttribute('data-id'));
    });


    // åˆæœŸæç”»
    renderManage();
  }


  // --- ç”»é¢é·ç§»æ™‚ã®ãƒ•ãƒƒã‚¯ã«è¿½åŠ  ---
  const _origShowScreen = showScreen;
  showScreen = function(screenId){
    _origShowScreen(screenId);
    if (screenId === 'manage-projects') initManage();
  };


  // ãƒãƒ£ãƒƒãƒˆå†…ã®ã€Œæ‰¿èªã€ã€Œå·®ã—æˆ»ã—ã€ï¼ˆãƒ‡ãƒ¢ç”¨ï¼‰ã‚’æ‹¾ã†
  $('#chat').addEventListener('click', (e)=>{
    const targetText = e.target?.textContent?.trim();


    if (targetText === '[æ‰¿èªã™ã‚‹]' || targetText === '[å·®ã—æˆ»ã™]') {
      // ç›´è¿‘ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã‚‰ projectId ã‚’ç‰¹å®šï¼ˆç°¡æ˜“å®Ÿè£…ï¼‰
      // å®Ÿè£…æ–¹æ³•ï¼šapproval_actions ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã® meta.projectId ã‚’å‚ç…§
      const chatId = state.selectedChatId;
      const chat = state.chats?.find(c => c.id === chatId);
      if (!chat) return;


      const actionMsg = [...chat.messages].reverse().find(m => m.kind === 'approval_actions' && m.meta?.projectId);
      if (!actionMsg) return;


      const projectId = actionMsg.meta.projectId;
      const proj = state.manage.projects.find(p => p.id === projectId);
      if (!proj) return;


      const now = new Date().toLocaleString('ja-JP', { hour12: false });


      if (targetText === '[æ‰¿èªã™ã‚‹]') {
        proj.approval = 'approved';
        proj.status = 'done'; // æ‰¿èªï¼å®Œäº†ã¸
        chat.messages.push({ from: 'client', text: 'âœ… æ‰¿èªã—ã¾ã—ãŸã€‚ãŠã¤ã‹ã‚Œã•ã¾ã§ã—ãŸï¼', at: now });
        chat.lastMessage = 'æ‰¿èªã•ã‚Œã¾ã—ãŸã€‚';
      } else {
        proj.approval = 'rejected';
        // å·®ã—æˆ»ã—æ™‚ã¯é€²è¡Œä¸­ã®ã¾ã¾ï¼ˆæŒ‡ç¤ºã«å¿œã˜ã¦å¤‰æ›´OKï¼‰
        if (proj.status === 'done') proj.status = 'in_progress';
        chat.messages.push({ from: 'client', text: 'â†©ï¸ å·®ã—æˆ»ã—ã¾ã™ã€‚ä¿®æ­£ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚', at: now });
        chat.lastMessage = 'å·®ã—æˆ»ã—ã•ã‚Œã¾ã—ãŸã€‚';
      }
      chat.lastAt = now;


      renderManage();
      openChatDetail(chatId); // ç”»é¢ã‚’å³æ›´æ–°
    }
  });


  // ------------------- Initial screen -------------------
  showScreen('dashboard');
});
</script>
</body>
</html>